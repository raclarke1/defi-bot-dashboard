<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi Bot Dashboard | Jarvis</title>
    <meta http-equiv="refresh" content="60">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-blue: #58a6ff;
            --border-color: #30363d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        h1 { font-size: 24px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-trading { background: var(--accent-blue); color: #fff; }
        .status-idle { background: var(--text-secondary); color: #fff; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .card-title { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .card-value { font-size: 28px; font-weight: 700; }
        .card-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }
        .trade-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid var(--accent-blue); }
        .trade-short { background: var(--accent-red); color: #fff; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 14px; }
        .trade-long { background: var(--accent-green); color: #fff; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 14px; }
        .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .order-item:last-child { border-bottom: none; }
        .log-entry { padding: 10px; border-left: 3px solid var(--border-color); margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 0 8px 8px 0; font-size: 13px; }
        .log-time { font-size: 11px; color: var(--text-secondary); }
        footer { text-align: center; padding: 24px; color: var(--text-secondary); font-size: 12px; }
        #loading { text-align: center; padding: 40px; color: var(--text-secondary); }
        .no-position { text-align: center; padding: 40px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ DeFi Bot v3.2</h1>
            <div>
                <span id="status-badge" class="status-badge status-idle">Loading...</span>
                <span id="last-update" style="margin-left: 12px; color: var(--text-secondary);"></span>
            </div>
        </header>
        
        <div id="loading">Loading dashboard data...</div>
        <div id="dashboard" style="display: none;">
            <!-- Position Card -->
            <div id="position-card" class="card trade-card" style="margin-bottom: 24px;">
            </div>
            
            <!-- Account Stats -->
            <div class="grid">
                <div class="card">
                    <div class="card-title">üí∞ Equity</div>
                    <div id="equity" class="card-value">$0.00</div>
                    <div id="collateral" class="card-subtitle">Collateral: $0.00</div>
                </div>
                <div class="card">
                    <div class="card-title">üìä Leverage</div>
                    <div id="leverage" class="card-value">0.00x</div>
                    <div id="free-collateral" class="card-subtitle">Free: $0.00</div>
                </div>
                <div class="card">
                    <div class="card-title">üìà Unrealized PnL</div>
                    <div id="pnl" class="card-value">$0.00</div>
                    <div class="card-subtitle">Current session</div>
                </div>
            </div>
            
            <!-- Orders -->
            <div class="card" style="margin-bottom: 24px;">
                <div class="card-title">üõ°Ô∏è On-Chain Orders</div>
                <div id="orders-list"></div>
            </div>
            
            <!-- Activity Log -->
            <div class="card">
                <div class="card-title">üìã Activity Log</div>
                <div id="activity-log" style="max-height: 300px; overflow-y: auto; margin-top: 12px;"></div>
            </div>
        </div>
        
        <footer>
            DeFi Bot by Jarvis | Strategy v3.2 | Auto-refreshes every 60s
        </footer>
    </div>
    
    <script>
        async function loadDashboard() {
            try {
                const response = await fetch('state.json?' + Date.now());
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Update header
                const statusBadge = document.getElementById('status-badge');
                statusBadge.textContent = data.status || 'IDLE';
                statusBadge.className = 'status-badge ' + (data.status === 'TRADING' ? 'status-trading' : 'status-idle');
                
                const updateTime = new Date(data.lastUpdate).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', timeZoneName: 'short'
                });
                document.getElementById('last-update').textContent = 'Updated: ' + updateTime;
                
                // Update account stats
                const drift = data.drift || {};
                document.getElementById('equity').textContent = '$' + (drift.equity || 0).toFixed(2);
                document.getElementById('collateral').textContent = 'Collateral: $' + (drift.totalCollateral || 0).toFixed(2);
                document.getElementById('leverage').textContent = (drift.leverage || 0).toFixed(2) + 'x';
                document.getElementById('free-collateral').textContent = 'Free: $' + (drift.freeCollateral || 0).toFixed(2);
                
                const pnlEl = document.getElementById('pnl');
                const pnl = drift.unrealizedPnl || 0;
                pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
                pnlEl.className = 'card-value ' + (pnl >= 0 ? 'positive' : 'negative');
                
                // Update position
                const positionCard = document.getElementById('position-card');
                const position = drift.position;
                
                if (position && drift.leverage > 0.01) {
                    const dirClass = position.direction === 'SHORT' ? 'trade-short' : 'trade-long';
                    positionCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <span class="card-title">üéØ CURRENT POSITION</span>
                            <span class="${dirClass}">${position.direction}</span>
                        </div>
                        <div class="grid" style="margin-bottom: 0;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700;">${position.asset || 'Unknown'}</div>
                                <div class="card-subtitle">Size: ${position.size || 0} (~$${position.notional || 0})</div>
                            </div>
                            <div>
                                <div class="card-subtitle">Stop Loss</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--accent-red);">$${(position.stopLoss || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="card-subtitle">Take Profit</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--accent-green);">$${(position.takeProfit || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div class="card-subtitle">Funding Rate</div>
                                <div style="font-size: 20px; font-weight: 600;">${position.fundingRate || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    positionCard.innerHTML = '<div class="no-position">No open positions</div>';
                }
                
                // Update orders
                const ordersList = document.getElementById('orders-list');
                const orders = data.openOrders || [];
                if (orders.length > 0) {
                    ordersList.innerHTML = orders.map(o => `
                        <div class="order-item">
                            <span>${o.type}</span>
                            <span>$${o.trigger.toLocaleString()} (${o.status})</span>
                        </div>
                    `).join('');
                } else {
                    ordersList.innerHTML = '<div style="color: var(--text-secondary); padding: 8px 0;">No open orders</div>';
                }
                
                // Update activity log
                const activityLog = document.getElementById('activity-log');
                const logs = data.activityLog || [];
                activityLog.innerHTML = logs.map(log => `
                    <div class="log-entry">
                        <span class="log-time">${log.time}</span> ‚Äî ${log.message}
                    </div>
                `).join('');
                
            } catch (err) {
                document.getElementById('loading').textContent = 'Error loading data: ' + err.message;
            }
        }
        
        loadDashboard();
        setInterval(loadDashboard, 60000);
    </script>
</body>
</html>
